<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Kariba: using</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Kariba
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_using.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">using</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md49"></a>
Using and developing with or for the Kariba library</h1>
<p>There are three kind of uses of the Kariba library:</p>
<ul>
<li>you are creating your own model, using the functionality of the library; you don't need extra functionality.</li>
<li>you are creating your own model, but you need to extend some functionality of the library.</li>
<li>you are improving, extending or fixing bugs in the library</li>
</ul>
<p>These three scenarios are detailed below</p>
<h2><a class="anchor" id="autotoc_md50"></a>
Creating your own model using the library</h2>
<p>In this case, build and install the library first, as described in the installation section. Note in which directory you installed the library, or perhaps you left it where it was build. Both options are fine.</p>
<p>For your model, create directory outside of the Kariba repository. This should probably become a Git repository of its own, to manage changes to your own model (including, for example, experimental versions on Git branches).</p>
<p>So you'd have two or optionally three directories: one with the Kariba repository, one with your model repository, and an optional one where you may have the Kariba library installed. For me, that would be something like</p>
<div class="fragment"><div class="line">$HOME/code/kariba</div>
<div class="line">$HOME/code/my_model</div>
<div class="line">$HOME/sw</div>
</div><!-- fragment --><p>Once you've written the start of your model, add the necessary Kariba include files to your sources, e.g.</p>
<div class="fragment"><div class="line">#include &lt;kariba/Powerlaw.hpp&gt;</div>
<div class="line">#include &lt;kariba/Thermal.hpp&gt;</div>
</div><!-- fragment --><p>Note the use of angular brackets and the kariba/ directory prefix.</p>
<p>When you compile your code, you will need the <code>-I</code> option to point the compiler to the Kariba header files.</p>
<p>If you didn't install Kariba in a separate directory, these should point to the directory where the Kariba library was compiled and which has the header files in the 'kariba' subdirectory. Also, find path of the 'libkariba.a' static library, which is probably in the same directory. Then, set <code>-I</code> to have this directory included, and include the full path to the 'libkariba.a' library with your compilation. In the above example, the relevant directory is <code>$HOME/code/kariba/src</code>, so something like the following compilation command works (<code>mymodel.cpp</code> and <code>utils.cpp</code> being local project files):</p>
<div class="fragment"><div class="line">g++ -std=c++17 -O3 -Wall -Wextra -I$HOME/code/kariba/src $HOME/code/kariba/src/libkariba.a -lgsl -lm -o mymodel mymodel.cpp utils.cpp</div>
</div><!-- fragment --><p>Note there is no <code>-L</code> flag before the 'libkariba.a' path.</p>
<p>Add an <code>-fopenmp</code> flag if needed, and replace <code>-O3</code> with e.g. <code>-Ofast</code> if wanted (and deemed safe).</p>
<p>If you installed the library (and its header files) in a separate directory, it's very similar. With the above example, it now becomes</p>
<div class="fragment"><div class="line">g++ -std=c++17 -O3 -Wall -Wextra -I$HOME/sw/include $HOME/code/kariba/sw/lib/libkariba.a -lgsl -lm -o mymodel mymodel.cpp utils.cpp</div>
</div><!-- fragment --><p>The above two variants compile your code with a static variant of the Kariba library. If you'd like, you can use the dynamic library instead. The compilation variants then look as follows (using the <code>-L</code> option this time):</p>
<div class="fragment"><div class="line">g++ -std=c++17 -O3 -Wall -Wextra -I$HOME/code/kariba/src -L$HOME/code/kariba/src -lkariba -lgsl -lm -o mymodel mymodel.cpp utils.cpp</div>
</div><!-- fragment --><p>(not installed; directly from the source repository)</p>
<p>and</p>
<div class="fragment"><div class="line">g++ -std=c++17 -O3 -Wall -Wextra -I$HOME/sw/include -L$HOME/code/kariba/sw/lib/ -lkariba -lgsl -lm -o mymodel mymodel.cpp utils.cpp</div>
</div><!-- fragment --><p>With this variant, you'll need to set your <code>LD_LIBRARY_PATH</code> (on Linux) or <code>DYLD_LIBRARY_PATH</code> (on macOS) environment variables to point to the Kariba shared library. That would be (bash, zsh):</p>
<div class="fragment"><div class="line">export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:$HOME/sw/lib</div>
</div><!-- fragment --><p>for a Linux installed variant, and similar for not-installed versions and macOS, replacing the path and/or environment variable accordingly.</p>
<p>The static library is easier to use. The advantage of a shared library can be that, if that library changes (e.g., because there was a bug fix of a specific function) and the library is updated (you re-installed the Kariba library), then your model follows that fix. With a static library, you would have to recompile your model as well. But it is likely that that is very quick, so you can probably still use the static library variant without hassle, even in the rare cases of updates to the Kariba library.</p>
<h2><a class="anchor" id="autotoc_md51"></a>
Creating your own model using the library, extending some parts of the library</h2>
<p>Essentially, you work the same way as above: create a repository for your model separately and independently from the Kariba library, and compile as suggested above.</p>
<p>For parts where you want to extend functionality, there may be a few ways to go about:</p>
<h3><a class="anchor" id="autotoc_md52"></a>
Extend or change class functionality (e.g., a member function)</h3>
<p>If you want to add or change the behaviour of a function of a particular Kariba class, you can do that fairly easily: use the C++ inheritance abilities to create a new class, inheriting from an existing Kariba class you'd like to extend, then add the new function, or override an existing function.</p>
<p>As an example, let's say we want to change the <code>set_p()</code> member function of the <code><a class="el" href="classkariba_1_1Thermal.html" title="Class for thermal particles. ndens is number density per unit momentum.">kariba::Thermal</a></code> class. The minimum and maximum energy are not what we'd like (first lines of the original function):</p>
<div class="fragment"><div class="line">void Thermal::set_p() {    //</div>
<div class="line">    double emin =</div>
<div class="line">        (1. / 100.) * Temp;      // minimum energy in kev, 1/100 lower than peak</div>
<div class="line">    double emax = 20. * Temp;    // maximum energy in kev, 20 higher than peak</div>
<div class="line">    double gmin, gmax, pmin, pmax, pinc;</div>
<div class="line">...</div>
</div><!-- fragment --><p>So create a new header file (or add to an existing one), and include the following:</p>
<div class="fragment"><div class="line">#include &lt;kariba/Thermal&gt;</div>
<div class="line"> </div>
<div class="line">class Thermal2 : public Thermal {</div>
<div class="line">  public:</div>
<div class="line">    // inherit constructors; only works if there are new extra member variables to initialize</div>
<div class="line">    using Thermal::Thermal;</div>
<div class="line"> </div>
<div class="line">    void set_p();</div>
<div class="line">};</div>
</div><!-- fragment --><p>and in a source file, define the class and implement the overriddend function:</p>
<div class="fragment"><div class="line">#include &quot;thermal2.hpp&quot;</div>
<div class="line"> </div>
<div class="line">Thermal2::set_p() {    //</div>
<div class="line">    double emin =</div>
<div class="line">        (1. / 10.) * Temp;      // minimum energy in kev, 1/100 lower than peak</div>
<div class="line">    double emax = 2. * Temp;    // maximum energy in kev, 20 higher than peak</div>
<div class="line">    double gmin, gmax, pmin, pmax, pinc;</div>
<div class="line">...</div>
</div><!-- fragment --><p>where you will need to write the rest of the function in the place of the ellipses, of course (so copy-paste the old function, change <code>Thermal</code> to <code>Thermal2</code>, make the actual changes for <code>emin</code> and <code>max</code>, and you're good).</p>
<p>Note that we don't need to override the constructor, or any of the other functions. As long as these stay the same, and there are no new member variables that need to be initialized in the constructor, there is no need for this.</p>
<p>When inheriting, be aware of the access priviliges:</p>
<ul>
<li>all member variables in the base classes are protected. That way, they can be accessed directly from a child class.</li>
<li>inherit with <code>public</code>. That way, member variables are still protected in derived (child) classes, so that every grandchildren can access their grandparents' member variables. While it can be argued this is not (always) good, in cases like the above, this is a major and important convenience (otherwise, you'd need to add a lot of setters and getters to the base class).</li>
<li>member functions, overridden or newly added, should practically always be <code>public</code>.</li>
<li>the <code>using Thermal::Thermal</code> tells the compiler that <code>Thermal2</code> should use the matching constructor from <code>Thermal</code> to initialize the class and its member variables (matching here means, by arguments; if there's only one constructor, which is the case in all Kariba classes, this doesn't matter).</li>
</ul>
<hr  />
<p>Logically, perhaps, the lower and upper boundary factors should be arguments in <code>set_p()</code>, perhaps with default settings of 1/100 and</p><ol type="1">
<li>Which leads to the third variant of working with Kariba: extending the library, adding improvements or simply fixing bugs</li>
</ol>
<h2><a class="anchor" id="autotoc_md54"></a>
Improve, extend or fix a bug in the library</h2>
<p>In this case, you'll work directly in the Kariba repository. However, do this on a new branch.</p>
<p>These changes should be for long-term changes; if you have something that is for a specific or temporary case, use the workflow in the section above.</p>
<h3><a class="anchor" id="autotoc_md55"></a>
Git setup</h3>
<p>First, check that you actually have and use a (GitHub) fork of the library. On GitHub, fork the repository. Then, copy the URL for the SSH-variant of the cod of your fork.</p>
<p>Now, back in the terminal on your local machine, check the remotes of the Kariba library:</p>
<div class="fragment"><div class="line">git remote -v</div>
</div><!-- fragment --><p>If you see an 'upstream' and 'origin' remote, check that 'upstream' URL points to the original repository, not your fork. The 'origin' URL should point to your fork, with the URL starting with <code>git@github.com:</code> (this indicates SSH is used).</p>
<p>If you only see an 'origin' remote, it likely points to the original repository, not your fork. Change that:</p>
<div class="fragment"><div class="line">git remote set-url origin git@github.com:&lt;username&gt;/kariba.git</div>
</div><!-- fragment --><p>(the URL is the one you copied from GitHub; obviously <code>&lt;username&gt;</code> is your user name.)</p>
<p>Now add the URL to the original Kariba repository as an upstream:</p>
<div class="fragment"><div class="line">git remote set-url origin https//github.com/kariba/kariba.git</div>
</div><!-- fragment --><p>Check <code>git remote -v</code> again to see that the URLs and names now match as mentioned above.</p>
<h3><a class="anchor" id="autotoc_md56"></a>
Create a branch and add your changes</h3>
<p>Create a separate branch, from the main branch, and add your changes there.</p>
<p>When finished, test that the library still builds, and that the unit tests and examples still build and run. If there was a fix that changes the outcome of a function, update the unit test accordingly (just be sure that your change is correct). If you added a function, add one or a few unit tests that specifically test this function.</p>
<h3><a class="anchor" id="autotoc_md57"></a>
Push the branch and create a pull request</h3>
<p>Once everything is commit (you can easily make multipe small commits if it makes sense), first check that you are still up to date with the upstream repository. Pull in any changes and rebase upstream/main:</p>
<div class="fragment"><div class="line">git fetch upstream</div>
<div class="line">git rebase upstream/main</div>
</div><!-- fragment --><p>Then push the branch to your fork:</p>
<div class="fragment"><div class="line">git push origin &lt;mybranch&gt;</div>
</div><!-- fragment --><p>Now, on GitHub, create a pull request from that branch to the original repository. There is likely a big green button on the GitHub page: click it to prepare the pull request.</p>
<p>Fill out the necessary details, check again if everything looks good, then create the pull request (PR).</p>
<p>You are automatically already on the origina repository site, on the details for your PR. If everything went correctly, the continuous integration (CI) tests will be run. Wait to see if these all pass.</p>
<p>Now you'll hae to wait until a maintainer merges your PR. Or they may have some further questions or suggestions to improve your PR.</p>
<p>If you yourself are the maintainer, I'd suggest to wait a few days before merging. Sometimes, you later realise you have forgotten something, and you can then still easily add it to the PR.</p>
<p>Note: please avoid pushing directly to the original repository in you are a maintainer (or even directly to the main branch): using a personal fork makes following the flow of updates much easier. The PR, and changes that came with, is nicely laid out on GitHub (also when closed), and because merging a PR creates a merge commit, there are clear points where a consistent set of changes was added to the library.</p>
<h3><a class="anchor" id="autotoc_md58"></a>
Updating the pull request</h3>
<p>Sometimes you want to update a pending pull request: you've forgotten to commit a file, accidentally commited a file that shouldn't be there[*], or made a typo while changing things.</p>
<p>For that, go to the correct branch in your local repository, make the changes as needed, then force-push the branch to your fork:</p>
<div class="fragment"><div class="line">git push origin &lt;mybranch&gt; --force</div>
</div><!-- fragment --><p>You may not need the <code>--force</code> flag, if you only added commits. If you changed commits (with <code>--amend</code>, or an interactive rebase, to keep the PRs history cleaner), then <code>--force</code> is needed.</p>
<p>Once updated, the CI for the PR should run again, so check that your updates didn't make the tests fail.</p>
<hr  />
<p>[*] If you accidentally pushed a private key, a password, or some other secret onto GitHub, then changing things and force-pushing the update won't help. Even if you overwrite the Git history (an interactive rebase can do that), bots scrape GitHub all the time, and the secret may already have been comprised. Do get rid of the secret in the code, but also change the relevant secret as soon as possible. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
